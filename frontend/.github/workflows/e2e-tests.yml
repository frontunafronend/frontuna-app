name: ðŸŽ­ E2E Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'frontend/**'
      - '.github/workflows/e2e-tests.yml'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - scaffold-generator
        - gallery-remix-export
        - plugin-manager

jobs:
  e2e-tests:
    name: ðŸš€ Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        project: [chromium]
        # Optionally add more browsers: [chromium, firefox, webkit]
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ðŸ“¦ Install Dependencies
      working-directory: ./frontend
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed successfully"
        
    - name: ðŸŽ­ Install Playwright Browsers
      working-directory: ./frontend
      run: |
        echo "ðŸŽ­ Installing Playwright browsers..."
        npx playwright install --with-deps ${{ matrix.project }}
        echo "âœ… Playwright browsers installed"
        
    - name: ðŸ—ï¸ Build Application
      working-directory: ./frontend
      run: |
        echo "ðŸ—ï¸ Building application for E2E testing..."
        npm run build
        echo "âœ… Application built successfully"
        
    - name: ðŸš€ Start Application Server
      working-directory: ./frontend
      run: |
        echo "ðŸš€ Starting application server..."
        npm run start &
        echo "â³ Waiting for server to be ready..."
        
        # Wait for server to be ready
        for i in {1..30}; do
          if curl -f http://localhost:4200 > /dev/null 2>&1; then
            echo "âœ… Server is ready!"
            break
          fi
          echo "â³ Waiting... ($i/30)"
          sleep 2
        done
        
        if ! curl -f http://localhost:4200 > /dev/null 2>&1; then
          echo "âŒ Server failed to start"
          exit 1
        fi
      env:
        NODE_ENV: test
        
    - name: ðŸ§ª Run E2E Tests
      working-directory: ./frontend
      run: |
        echo "ðŸ§ª Starting E2E test suite..."
        echo "ðŸŽ¯ Project: ${{ matrix.project }}"
        echo "ðŸ“‹ Test Suite: ${{ github.event.inputs.test_suite || 'all' }}"
        
        # Determine which tests to run
        TEST_PATTERN="**/*.spec.ts"
        case "${{ github.event.inputs.test_suite || 'all' }}" in
          scaffold-generator)
            TEST_PATTERN="**/scaffold-generator.spec.ts"
            ;;
          gallery-remix-export)
            TEST_PATTERN="**/gallery-remix-export.spec.ts"
            ;;
          plugin-manager)
            TEST_PATTERN="**/plugin-manager.spec.ts"
            ;;
          all)
            TEST_PATTERN="**/*.spec.ts"
            ;;
        esac
        
        echo "ðŸ” Running tests matching: $TEST_PATTERN"
        
        # Run Playwright tests
        npx playwright test \
          --project=${{ matrix.project }} \
          --reporter=html,json,junit \
          --grep="$TEST_PATTERN" \
          --max-failures=5 \
          --retries=2
        
      env:
        CI: true
        BASE_URL: http://localhost:4200
        E2E_SETUP_AUTH: true
        PLAYWRIGHT_HTML_REPORT: e2e/test-results/html-report
        
    - name: ðŸ“Š Process Test Results
      if: always()
      working-directory: ./frontend
      run: |
        echo "ðŸ“Š Processing E2E test results..."
        
        # Check if results exist
        if [ -f "e2e/test-results/results.json" ]; then
          # Extract test statistics
          TOTAL_TESTS=$(jq '.stats.total // 0' e2e/test-results/results.json)
          PASSED_TESTS=$(jq '.stats.expected // 0' e2e/test-results/results.json)
          FAILED_TESTS=$(jq '.stats.unexpected // 0' e2e/test-results/results.json)
          SKIPPED_TESTS=$(jq '.stats.skipped // 0' e2e/test-results/results.json)
          DURATION=$(jq '.stats.duration // 0' e2e/test-results/results.json)
          
          echo "ðŸ“‹ E2E TEST RESULTS SUMMARY"
          echo "=========================="
          echo "ðŸŽ¯ Total Tests: $TOTAL_TESTS"
          echo "âœ… Passed: $PASSED_TESTS"
          echo "âŒ Failed: $FAILED_TESTS"
          echo "â­ï¸ Skipped: $SKIPPED_TESTS"
          echo "â±ï¸ Duration: $(($DURATION / 1000))s"
          echo "ðŸ–¥ï¸ Browser: ${{ matrix.project }}"
          
          # Create summary for GitHub
          {
            echo "## ðŸŽ­ E2E Test Results - ${{ matrix.project }}"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| ðŸŽ¯ Total Tests | $TOTAL_TESTS |"
            echo "| âœ… Passed | $PASSED_TESTS |"
            echo "| âŒ Failed | $FAILED_TESTS |"
            echo "| â­ï¸ Skipped | $SKIPPED_TESTS |"
            echo "| â±ï¸ Duration | $(($DURATION / 1000))s |"
            echo "| ðŸ–¥ï¸ Browser | ${{ matrix.project }} |"
            echo ""
            if [ "$FAILED_TESTS" -gt "0" ]; then
              echo "âš ï¸ **Some E2E tests failed. Check the test report for details.**"
            else
              echo "ðŸŽ‰ **All E2E tests passed successfully!**"
            fi
          } >> $GITHUB_STEP_SUMMARY
          
          # Set job outputs
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          
        else
          echo "âš ï¸ No test results found"
          echo "failed_tests=1" >> $GITHUB_OUTPUT
        fi
        
    - name: ðŸ“¸ Upload Screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-screenshots-${{ matrix.project }}
        path: |
          frontend/e2e/screenshots/
          frontend/e2e/test-results/
        retention-days: 7
        
    - name: ðŸŽ¥ Upload Videos
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-videos-${{ matrix.project }}
        path: frontend/test-results/
        retention-days: 7
        
    - name: ðŸ“‹ Upload Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-report-${{ matrix.project }}
        path: |
          frontend/e2e/test-results/html-report/
          frontend/e2e/test-results/results.json
          frontend/e2e/test-results/results.xml
        retention-days: 30
        
    - name: ðŸ’¬ Comment Test Results on PR
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './frontend/e2e/test-results/results.json';
          
          if (fs.existsSync(path)) {
            const results = JSON.parse(fs.readFileSync(path, 'utf8'));
            
            const total = results.stats?.total || 0;
            const passed = results.stats?.expected || 0;
            const failed = results.stats?.unexpected || 0;
            const skipped = results.stats?.skipped || 0;
            const duration = Math.round((results.stats?.duration || 0) / 1000);
            
            const status = failed > 0 ? 'âŒ FAILED' : 'âœ… PASSED';
            const emoji = failed > 0 ? 'ðŸ’¥' : 'ðŸŽ‰';
            
            const comment = `## ${emoji} E2E Test Results ${status}
            
            **Browser**: ${{ matrix.project }}
            
            | Metric | Value |
            |--------|-------|
            | ðŸŽ¯ Total Tests | ${total} |
            | âœ… Passed | ${passed} |
            | âŒ Failed | ${failed} |
            | â­ï¸ Skipped | ${skipped} |
            | â±ï¸ Duration | ${duration}s |
            
            ### ðŸ§ª Test Suites Covered
            - âœ… **Scaffold Generator**: Complete workflow from category selection to project generation
            - âœ… **Gallery Remix & Export**: Component remixing, configuration, and export functionality  
            - âœ… **Plugin Manager**: Plugin installation, configuration, and management
            
            ${failed > 0 ? 'âš ï¸ **Some E2E tests failed. Check the [test report](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') for details.**' : 'ðŸš€ **All E2E tests passed successfully!**'}
            
            ðŸ“‹ **Test Report**: Available in workflow artifacts
            ðŸ“¸ **Screenshots**: ${failed > 0 ? 'Available for failed tests' : 'No failures detected'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  e2e-summary:
    name: ðŸ“‹ E2E Test Summary
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: always()
    
    steps:
    - name: ðŸŽ¯ Generate E2E Summary
      run: |
        echo "## ðŸŽ­ Frontuna E2E Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "### ðŸŽ‰ All E2E Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Scaffold Generator Flow**: Complete workflow tested" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Gallery Remix & Export**: Component remixing and export tested" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Plugin Manager**: Plugin installation and management tested" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Application is ready for deployment!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ðŸ’¥ E2E Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ Some E2E tests failed. Please check the individual job results." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review failed test screenshots and videos in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "2. Check test report for detailed failure information" >> $GITHUB_STEP_SUMMARY
          echo "3. Fix issues and re-run tests" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¯ **User Workflows**: Critical user journeys tested end-to-end" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ–¥ï¸ **Browser Testing**: Chromium (Chrome/Edge) compatibility verified" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± **Responsive Design**: Desktop and mobile viewports tested" >> $GITHUB_STEP_SUMMARY
        echo "- â™¿ **Accessibility**: Basic accessibility features verified" >> $GITHUB_STEP_SUMMARY