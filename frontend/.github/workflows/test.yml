name: ðŸ§ª Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: ðŸš€ Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ðŸ“¦ Install Dependencies
      working-directory: ./frontend
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed successfully"
        
    - name: ðŸ”§ Setup Chrome for Testing
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
        
    - name: ðŸ§ª Run Test Suite
      working-directory: ./frontend
      run: |
        echo "ðŸ§ª Starting comprehensive test suite..."
        echo "ðŸŽ¯ Running tests with coverage reporting..."
        
        # Run tests with coverage and custom output formatting
        npm run test:ci 2>&1 | tee test-output.log
        
        # Extract test results
        echo ""
        echo "ðŸ“Š TEST RESULTS SUMMARY"
        echo "======================="
        
        # Count total tests and failures from the log
        TOTAL_TESTS=$(grep -o "Executed [0-9]*" test-output.log | tail -1 | grep -o "[0-9]*" || echo "0")
        FAILED_TESTS=$(grep -o "[0-9]* FAILED" test-output.log | grep -o "^[0-9]*" || echo "0")
        PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
        
        echo "ðŸŽ¯ Total Test Cases: $TOTAL_TESTS"
        echo "âœ… Passed Tests: $PASSED_TESTS"
        echo "âŒ Failed Tests: $FAILED_TESTS"
        
        # Check if any tests failed
        if [ "$FAILED_TESTS" -gt "0" ]; then
          echo ""
          echo "ðŸ’¥ TEST FAILURES DETECTED!"
          echo "========================="
          echo "âŒ $FAILED_TESTS out of $TOTAL_TESTS tests failed"
          echo ""
          echo "ðŸ“‹ Failure Details:"
          grep -A 5 -B 2 "FAILED\|ERROR" test-output.log || echo "Check test-output.log for detailed failure information"
          exit 1
        else
          echo ""
          echo "ðŸŽ‰ ALL TESTS PASSED!"
          echo "==================="
          echo "âœ… $TOTAL_TESTS tests executed successfully"
          echo "ðŸš€ Test suite completed without errors"
        fi
        
    - name: ðŸ“Š Upload Coverage Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-node-${{ matrix.node-version }}
        path: frontend/coverage/
        retention-days: 30
        
    - name: ðŸ“„ Upload Test Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-node-${{ matrix.node-version }}
        path: frontend/test-output.log
        retention-days: 7
        
    - name: ðŸ’¬ Comment Test Results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = './frontend/test-output.log';
          
          if (fs.existsSync(path)) {
            const testOutput = fs.readFileSync(path, 'utf8');
            const totalMatch = testOutput.match(/Executed (\d+)/);
            const failedMatch = testOutput.match(/(\d+) FAILED/);
            
            const total = totalMatch ? totalMatch[1] : '0';
            const failed = failedMatch ? failedMatch[1] : '0';
            const passed = total - failed;
            
            const status = failed > 0 ? 'âŒ FAILED' : 'âœ… PASSED';
            const emoji = failed > 0 ? 'ðŸ’¥' : 'ðŸŽ‰';
            
            const comment = `## ${emoji} Test Results ${status}
            
            | Metric | Value |
            |--------|-------|
            | ðŸŽ¯ Total Tests | ${total} |
            | âœ… Passed | ${passed} |
            | âŒ Failed | ${failed} |
            | ðŸŸ¢ Node.js | ${{ matrix.node-version }} |
            
            ${failed > 0 ? 'âš ï¸ **Some tests failed. Please check the workflow logs for details.**' : 'ðŸš€ **All tests passed successfully!**'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  test-summary:
    name: ðŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: test
    if: always()
    
    steps:
    - name: ðŸŽ¯ Generate Test Summary
      run: |
        echo "## ðŸ§ª Frontuna Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Node Version | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.test.result }}" == "success" ]]; then
          echo "| 18.x | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| 20.x | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **All tests passed successfully across all Node.js versions!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "| 18.x | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "| 20.x | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¥ **Some tests failed. Check the workflow logs for details.**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Test Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage reports are available in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- Test logs are uploaded for failed runs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Components Tested" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… AI Components (Scaffold Generator, Diff Viewer)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Versioning System (Version History)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Gallery System (Remix Card)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Plugin Manager" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Utilities and Helpers" >> $GITHUB_STEP_SUMMARY